# ระบบจัดการผู้ป่วย PGx (PGx Patient Management System)

## ภาพรวม

แอปพลิเคชันเดสก์ท็อปสำหรับบริหารจัดการข้อมูลผู้ป่วยและคำขอตรวจทางเภสัชพันธุศาสตร์ (PGx) ในสถานพยาบาลของไทย พัฒนาโดยใช้ Electron + Supabase + JavaScript ตามสถาปัตยกรรมแบบ MVC

## คุณสมบัติหลัก

- การจัดการผู้ป่วย: เพิ่ม แก้ไข ค้นหา และติดตามข้อมูลผู้ป่วย
- เวิร์กโฟลว์คำขอตรวจ: ครบวงจรตั้งแต่สร้างคำขอจนถึงออกไฟล์รายงาน
- รองรับหลายบทบาท: เภสัชกร นักเทคนิคการแพทย์ และผู้ดูแลระบบ
- วิเคราะห์ PGx: รองรับ 6 ยีน (CYP2D6, CYP2C9, CYP2C19, VKORC1, CYP3A5, TPMT)
- สร้างไฟล์ PDF: รายงานพร้อมข้อแนะนำการรักษาภาษาไทย
- บันทึกการใช้งาน: เก็บประวัติการทำงานในระบบ (Audit Log)
- ติดตาม TAT: แสดงสถานะเวลาที่ใช้เทียบกับ SLA แบบเรียลไทม์
- อินเทอร์เฟซสองภาษา: ไทย/อังกฤษ และมีโหมดมืด

## ยีนที่รองรับ

| ยีน | อัลลีลที่ตรวจ | จำนวนกฎ | รายละเอียด |
|------|---------------|-------|-------------|
| CYP2D6 | *4, *10, *41, CNV intron 2, CNV exon 9 | 33 | วิเคราะห์สำเนายีน (CNV) |
| CYP2C9 | *2, *3 | 6 | การเผาผลาญยา |
| CYP2C19 | *2, *3, *17 | 10 | การเผาผลาญยา |
| VKORC1 | 1173C>T, -1639G>A | 3 | ความไวต่อวาร์ฟาริน |
| CYP3A5 | *3 | 3 | การเผาผลาญยา |
| TPMT | *3C | 3 | ความไวต่อไทโอพูรีน |

## เทคโนโลยีที่ใช้

- ส่วนหน้า: HTML, CSS, JavaScript (Vanilla)
- ส่วนหลัง: Electron (Node.js)
- ฐานข้อมูล: Supabase (PostgreSQL)
- ยืนยันตัวตน: bcrypt สำหรับแฮชรหัสผ่าน
- สร้าง PDF: PDFKit พร้อมฟอนต์ภาษาไทย
- สื่อสารระหว่างส่วนหน้า/หลัง: Electron IPC

## สถาปัตยกรรมระบบ (MVC)

- Models (`src/models/`): เข้าถึง/จัดการข้อมูลในฐานข้อมูล
- Controllers (`src/controllers/`): ตรรกะธุรกิจและการประสานงานโมเดล
- Views (`view/`): ไฟล์ HTML + JS แยกหน้า
- Preload Bridge (`preload.js`): สะพาน IPC ที่ปลอดภัย
- Main Process (`main.js`): วงจรชีวิตแอปและตัวจัดการ IPC

## การติดตั้ง

### สิ่งที่ต้องมี

- Node.js เวอร์ชัน 16 ขึ้นไป
- npm หรือ yarn
- บัญชีและโปรเจกต์ Supabase

### ขั้นตอนตั้งค่า

1. โคลนโปรเจกต์
```bash
git clone <repository-url>
cd PGX-project-new
```

2. ติดตั้งแพ็กเกจ
```bash
npm install
```

   ขึ้นต่อไปนี้คือรายละเอียด dependencies ที่ใช้ในโปรเจกต์

   - `electron` (v38.3.0) – เฟรมเวิร์กสำหรับสร้างแอปเดสก์ท็อป
   - `@supabase/supabase-js` (v2.75.0) – ไคลเอนต์เชื่อมต่อ Supabase
   - `bcrypt` (v6.0.0) – ไลบรารีแฮชรหัสผ่าน
   - `bcryptjs` (v3.0.2) – เวอร์ชัน JavaScript ของ bcrypt
   - `dotenv` (v17.2.3) – จัดการตัวแปรสภาพแวดล้อมจากไฟล์ .env
   - `pdfkit` (v0.17.2) – สร้างไฟล์ PDF
   - `pdf-lib` (v1.17.1) – จัดการ/แก้ไขไฟล์ PDF
   - `xlsx` (v0.18.5) – อ่าน/เขียนไฟล์ Excel สำหรับ rulebase
   - `electron-store` (v11.0.2) – จัดเก็บข้อมูลถาวรในแอป Electron

   สำหรับการพัฒนา
   - `jest` (v29.7.0) – เฟรมเวิร์กสำหรับทดสอบ

3. สร้างไฟล์ `.env` ที่โฟลเดอร์ราก
```env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

4. เตรียมฐานข้อมูล
   - รันสคริปต์ SQL ในโฟลเดอร์ `rulebase/` เพื่อสร้างตาราง
   - ใช้ `scripts/initializeSpecimens.js` เพื่อตั้งค่า Specimen เริ่มต้น

5. เริ่มรันแอป
```bash
npm start
```

## โครงสร้างฐานข้อมูล (สรุป)

- `patient`: ข้อมูลประชากรผู้ป่วย
- `system_users`: บัญชีผู้ใช้และบทบาท
- `test_request`: คำขอตรวจและสถานะ
- `report`: รายงาน PGx ที่สร้างแล้ว
- `Specimen`: ประเภทสิ่งส่งตรวจและค่า SLA
- `audit_log`: ประวัติการทำงานของระบบ

### บทบาทผู้ใช้

- เภสัชกร: จัดการคำขอตรวจ กรอกอัลลีล ออกรายงาน
- นักเทคนิคการแพทย์: เพิ่มผู้ป่วยและสร้างคำขอตรวจ
- ผู้ดูแลระบบ: จัดการผู้ใช้ ตั้งค่า Specimen/ค่า SLA ดูบันทึกระบบ

## สคริปต์ที่ใช้บ่อย

ดูข้อมูลปัจจุบัน
```bash
node scripts/showRulebaseInfo.js
```

สำรองข้อมูล rulebase
```bash
node scripts/backupSupabaseToJson.js
```

นำเข้าข้อมูล rulebase
```bash
node scripts/importJsonToSupabase.js
```

ทดสอบการทำนาย
```bash
node scripts/testRulebase.js
```

ทดสอบสร้าง PDF
```bash
node scripts/testPdfGeneration.js
node scripts/testPdfGeneration.js --all
```

ตั้งค่า Specimen เริ่มต้น
```bash
node scripts/initializeSpecimens.js
```

## เวิร์กโฟลว์การใช้งาน

### นักเทคนิคการแพทย์
1) เข้าสู่ระบบด้วยบัญชี medtech
2) ไปที่เมนูจัดการผู้ป่วย
3) เพิ่ม/ค้นหาผู้ป่วย
4) สร้างคำขอตรวจ ระบุ Specimen และชนิด DNA
5) ติดตามสถานะในหน้า Case Management

### เภสัชกร
1) เข้าสู่ระบบด้วยบัญชี pharmacist
2) ดูคำขอตรวจที่รอดำเนินการ
3) กด "กรอก Alleles" เพื่อใส่ข้อมูลจีโนไทป์
4) ระบบทำนาย phenotype และข้อแนะนำ
5) ยืนยัน/ปรับแก้ข้อแนะนำ
6) สร้างไฟล์รายงาน PDF
7) เภสัชกรคนที่สองตรวจทานและยืนยัน

### ผู้ดูแลระบบ
1) เข้าสู่ระบบด้วยบัญชี admin
2) จัดการบัญชีผู้ใช้
3) ตั้งค่า Specimen และค่า SLA
4) ตรวจสอบ Audit Log
5) ติดตามสถิติการใช้งาน

## รายละเอียดฟีเจอร์สำคัญ

### การค้นหา
- ค้นหาผู้ป่วยด้วยรหัสหรือชื่อ (รองรับการพิมพ์บางส่วน)
- ไม่สนตัวพิมพ์เล็ก/ใหญ่
- กรองผลแบบเรียลไทม์

### การติดตาม TAT
- ปกติ: ใช้เวลาน้อยกว่า 80% ของ SLA
- เตือน: 80–100% ของ SLA
- เกินกำหนด: มากกว่า 100% ของ SLA
- คลิกการ์ดสถิติเพื่อกรองตามสถานะ TAT

### การจัดการเซสชัน
- จัดเก็บเซสชันฝั่งไคลเอนต์
- ออกจากระบบอัตโนมัติเมื่อหมดอายุ
- ตรวจสอบสิทธิ์ทุกหน้า

### รายงาน PDF
- รองรับภาษาไทยด้วยฟอนต์ Sarabun
- แสดงข้อมูลผู้ป่วย ผลจีโนไทป์/ฟีโนไทป์ ข้อแนะนำ และลายเซ็น
- บันทึกไฟล์อัตโนมัติในโฟลเดอร์ `reports/`

## ความปลอดภัย

- เปิดใช้งาน Context Isolation
- ปิด Node Integration ใน Renderer
- แฮชรหัสผ่านด้วย bcrypt (10 รอบเกลือ)
- ใช้ Service Role Key สำหรับงานฐานข้อมูลฝั่งเซิร์ฟเวอร์
- สื่อสารผ่าน IPC ที่ประกาศไว้ใน `preload.js`

## แนวทางพัฒนา

- ใช้ CommonJS (`require`/`module.exports`)
- โค้ดมีคอมเมนต์ภาษาไทยได้ตามต้นฉบับ และจัดการข้อผิดพลาดทุกคำสั่งฐานข้อมูล

### เพิ่มฟีเจอร์ใหม่
1) สร้าง Model (ถ้าจำเป็น) ใน `src/models/`
2) เขียนฟังก์ชันใน Controller ที่เกี่ยวข้องใน `src/controllers/`
3) ลงทะเบียน IPC ใน `main.js`
4) เปิดใช้ใน `preload.js`
5) เรียกใช้จากหน้า Renderer ผ่าน `window.electronAPI`

## เอกสารเพิ่มเติม

- **[MVC Architecture](docs/MVC_ARCHITECTURE.md)** – รายละเอียดสถาปัตยกรรม
- **[System Status](docs/SYSTEM_STATUS.md)** – สถานะการตั้งค่าระบบ
- **[Rulebase Management](docs/RULEBASE_MANAGEMENT.md)** – การจัดการข้อมูล rulebase
- **[Quick Start](docs/QUICK_START.md)** – เริ่มต้นใช้งาน
- **[Test Request Manager](docs/TEST_REQUEST_MANAGER.md)** – รายละเอียดเวิร์กโฟลว์คำขอตรวจ
- **[User Profile](docs/USER_PROFILE.md)** – การจัดการโปรไฟล์ผู้ใช้

## การแก้ปัญหาเบื้องต้น

### แอปไม่เริ่มทำงาน
- ตรวจสอบไฟล์ `.env` ว่ากำหนดค่า Supabase ถูกต้อง
- ใช้ Node.js เวอร์ชัน 16 ขึ้นไป
- ดูข้อความผิดพลาดในคอนโซล

### ค้นหาไม่ขึ้นผลลัพธ์
- ตรวจสอบการเชื่อมต่อฐานข้อมูล
- ดูข้อผิดพลาดในคอนโซลของหน้าเว็บ
- ตรวจรูปแบบคำค้นหา

### สร้าง PDF ไม่สำเร็จ
- ตรวจว่ามีโฟลเดอร์ `reports/`
- ตรวจว่ามีไฟล์ฟอนต์ไทยในโฟลเดอร์ `fonts/`
- ตรวจว่าข้อมูลผู้ป่วย/คำขอตรวจครบถ้วน

## สัญญาอนุญาต

สงวนลิขสิทธิ์ทั้งหมด (Proprietary)

## ติดต่อทีมพัฒนา

หากพบปัญหาหรือมีคำถาม โปรดติดต่อทีมพัฒนา

## สถานะโครงการ

กำลังพัฒนาอย่างต่อเนื่อง โดยปรับปรุงฟีเจอร์ตามความต้องการของผู้ใช้งานและหน่วยบริการสุขภาพ
